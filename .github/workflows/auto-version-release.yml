name: Auto-Version & Release
on:
  schedule:
    - cron: "0 23 * * *"
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  check-for-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    if: github.event_name != 'push'

    outputs:
      update_needed: ${{ steps.compare.outputs.update_needed }}
      new_xray_version: ${{ steps.compare.outputs.new_xray_version }}
      new_app_name: ${{ steps.update_versions.outputs.new_app_name }}
      new_app_code: ${{ steps.update_versions.outputs.new_app_code }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Get latest Xray-core tag
        id: get_tag
        run: |
          latest_tag=$(curl -sI https://github.com/XTLS/Xray-core/releases/latest | awk '/^location:/ {gsub(/.*tag\/v/, "", $2); gsub(/\r/, "", $2); print $2}')

          if [ -z "$latest_tag" ]; then
            echo "Failed to get latest tag" >&2
            exit 1
          fi

          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Latest Xray-core version: v$latest_tag"

      - name: Read current version.properties
        id: read_version
        run: |
          current_xray=$(grep '^XRAY_CORE_VERSION=' version.properties | sed 's/.*= *//; s/v//; s/ //g' | tr -d '\r')
          echo "current_xray=$current_xray" >> $GITHUB_OUTPUT
          echo "Current XRAY_CORE_VERSION: v$current_xray"

      - name: Compare versions
        id: compare
        run: |
          latest_tag="${{ steps.get_tag.outputs.latest_tag }}"
          current_xray="${{ steps.read_version.outputs.current_xray }}"

          if [ "$(echo -e "$current_xray\n$latest_tag" | sort -V | head -n 1)" != "$latest_tag" ]; then
            echo "Update available: v$current_xray -> v$latest_tag"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "new_xray_version=v$latest_tag" >> $GITHUB_OUTPUT
          else
            echo "No update needed" >&2
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify if no update needed
        id: notify_no_update
        if: steps.compare.outputs.update_needed != 'true'
        run: |
          echo "No Xray-core update available. Current version is up-to-date."
          echo "update_needed=false" >> $GITHUB_OUTPUT

      - name: Download and extract Xray
        if: steps.compare.outputs.update_needed == 'true'
        id: download
        run: |
          wget -q "https://github.com/XTLS/Xray-core/releases/download/v${{ steps.get_tag.outputs.latest_tag }}/Xray-linux-64.zip"
          unzip -q -o Xray-linux-64.zip
          chmod +x xray

          go_version=$(./xray version | grep -o 'go[0-9.]\+' | head -1 | sed 's/go//')

          if [ -z "$go_version" ]; then
            echo "Failed to extract Go version" >&2
            exit 1
          fi

          echo "go_version=$go_version" >> $GITHUB_OUTPUT
          echo "Extracted Go version: $go_version"

      - name: Update versions and commit
        if: steps.compare.outputs.update_needed == 'true'
        id: update_versions
        run: |
          git pull origin ${{ github.ref_name }}

          sed -i "s/^XRAY_CORE_VERSION=.*/XRAY_CORE_VERSION=${{ steps.compare.outputs.new_xray_version }}/" version.properties
          sed -i "s/^GO_VERSION=.*/GO_VERSION=${{ steps.download.outputs.go_version }}/" version.properties

          echo "Updated Go and Xray versions in version.properties."
          git config user.name "lhear"
          git config user.email "121179341+lhear@users.noreply.github.com"
          git add version.properties
          git commit -m "chore: Update Xray-core to v${{ steps.get_tag.outputs.latest_tag }}"

          app_code=$(grep '^APP_VERSION_CODE=' version.properties | sed 's/.*= *//; s/ //g')
          app_name=$(grep '^APP_VERSION_NAME=' version.properties | sed 's/.*= *//; s/ //g')

          new_app_code=$((app_code + 1))
          new_app_name=$(echo "$app_name" | awk -F. '{ $NF++; print }' OFS='.')

          sed -i "s/^APP_VERSION_CODE=.*/APP_VERSION_CODE=$new_app_code/" version.properties
          sed -i "s/^APP_VERSION_NAME=.*/APP_VERSION_NAME=$new_app_name/" version.properties

          echo "Updated app version in version.properties."
          git add version.properties
          git commit -m "chore(release): Bump version to $new_app_name"
          git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
          echo "new_app_name=$new_app_name" >> $GITHUB_OUTPUT
          echo "new_app_code=$new_app_code" >> $GITHUB_OUTPUT
          echo "update_needed=true" >> $GITHUB_OUTPUT

  build-and-release-from-update:
    name: Build and Release (from update)
    runs-on: ubuntu-latest
    needs: check-for-updates
    if: github.event_name != 'push' && always() && needs.check-for-updates.result != 'failure' && needs.check-for-updates.outputs.update_needed == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Explicit Submodule Update
        run: |
          # Only update submodules that exist in .gitmodules
          if [ -f .gitmodules ]; then
            git submodule sync --recursive || true
            git submodule update --init --recursive || true
          fi

      - name: Determine version
        id: version
        run: |
          VERSION_NAME="${{ needs.check-for-updates.outputs.new_app_name }}"
          TAG_NAME="v$VERSION_NAME"
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION_NAME"

      - name: Set up Java 22
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "22"
          cache: "gradle"
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Keystore and Properties
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE }}" | base64 -d > ./store.jks
          # Convert JKS to PKCS12 format to avoid "Tag number over 30" error
          # This error occurs with older JKS formats that use unsupported tag numbers (>30)
          # PKCS12 format is more compatible with modern Java versions
          echo "Converting keystore from JKS to PKCS12 format..."
          if keytool -importkeystore \
            -srckeystore ./store.jks \
            -srcstorepass "${{ secrets.SIGNING_STORE_PASSWORD }}" \
            -srcstoretype JKS \
            -destkeystore ./store.p12 \
            -deststorepass "${{ secrets.SIGNING_STORE_PASSWORD }}" \
            -deststoretype PKCS12 \
            -destkeypass "${{ secrets.SIGNING_KEY_PASSWORD }}" \
            -noprompt 2>&1; then
            echo "✓ Keystore converted to PKCS12 successfully"
            echo "storeFile=store.p12" > ./store.properties
            rm -f ./store.jks
          else
            echo "⚠ Keystore conversion failed, using original JKS format"
            echo "storeFile=store.jks" > ./store.properties
          fi
          echo "storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}" >> ./store.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> ./store.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> ./store.properties

      - name: Download Rules Files
        run: |
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      - name: Build Xray-core from Source
        run: |
          # Read NDK version from version.properties
          NDK_VERSION=$(grep '^NDK_VERSION=' version.properties | cut -d '=' -f 2 | tr -d ' ')
          NDK_MAJOR=$(echo "$NDK_VERSION" | cut -d '.' -f 1)

          # Determine NDK download URL (r28c format for version 28.x)
          if [ "$NDK_MAJOR" = "28" ]; then
            NDK_ZIP="android-ndk-r28c-linux.zip"
          else
            # Fallback to r28c if version format doesn't match
            NDK_ZIP="android-ndk-r28c-linux.zip"
          fi

          # Set up NDK
          wget -qO android-ndk.zip https://dl.google.com/android/repository/$NDK_ZIP
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)

          # Clone Xray-core source and checkout tag
          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          # Set common environment variables
          export GOOS=android
          export CGO_ENABLED=1

          # Build for arm64-v8a
          echo "Building for arm64-v8a..."
          export GOARCH=arm64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/arm64-v8a
          mv xray ../app/src/main/jniLibs/arm64-v8a/libxray.so

          # Build for x86_64
          echo "Building for x86_64..."
          export GOARCH=amd64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86_64
          mv xray ../app/src/main/jniLibs/x86_64/libxray.so

      - name: Set up Python for Model Training
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Train Policy Model
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install onnx onnxoptimizer tqdm numpy || true
          mkdir -p app/src/main/assets/models
          # Try to train model, but don't fail build if it fails
          python tools/train_hyperxray_policy_loss02_gpu.py || echo "Model training failed, continuing with build..."
        continue-on-error: true

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Find and Copy APKs
        run: |
          mkdir -p apks
          find app/build/outputs/apk/release -name "*.apk" -exec cp {} apks/ \;
          ls -lh apks/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hyperxray-apks-${{ steps.version.outputs.tag_name }}
          path: apks/
          if-no-files-found: error
          retention-days: 7

      - name: Get Release Notes
        id: release_notes
        env:
          XRAY_VERSION: ${{ needs.check-for-updates.outputs.new_xray_version }}
          TAG_NAME: ${{ steps.version.outputs.tag_name }}
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
        run: |
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          {
            echo "## Release ${TAG_NAME}"
            echo ""
            echo "### Changes"
            echo "- **Xray-core**: Updated to version **${XRAY_VERSION}**"
            echo "- **Version**: ${VERSION_NAME}"
            echo "- **Build Date**: ${BUILD_DATE}"
            echo ""
            echo "### APKs"
            echo "- Universal APK (all architectures)"
            echo "- ARM64-v8a APK"
            echo "- x86_64 APK"
          } > /tmp/release_notes.txt

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Release ${{ steps.version.outputs.tag_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
          files: apks/*.apk
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

  build-and-release-from-tag:
    name: Build and Release (from tag)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Explicit Submodule Update
        run: |
          # Only update submodules that exist in .gitmodules
          if [ -f .gitmodules ]; then
            git submodule sync --recursive || true
            git submodule update --init --recursive || true
          fi

      - name: Determine version
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION_NAME=${TAG_NAME#v}
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION_NAME"

      - name: Set up Java 22
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "22"
          cache: "gradle"
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Keystore and Properties
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE }}" | base64 -d > ./store.jks
          # Convert JKS to PKCS12 format to avoid "Tag number over 30" error
          # This error occurs with older JKS formats that use unsupported tag numbers (>30)
          # PKCS12 format is more compatible with modern Java versions
          echo "Converting keystore from JKS to PKCS12 format..."
          if keytool -importkeystore \
            -srckeystore ./store.jks \
            -srcstorepass "${{ secrets.SIGNING_STORE_PASSWORD }}" \
            -srcstoretype JKS \
            -destkeystore ./store.p12 \
            -deststorepass "${{ secrets.SIGNING_STORE_PASSWORD }}" \
            -deststoretype PKCS12 \
            -destkeypass "${{ secrets.SIGNING_KEY_PASSWORD }}" \
            -noprompt 2>&1; then
            echo "✓ Keystore converted to PKCS12 successfully"
            echo "storeFile=store.p12" > ./store.properties
            rm -f ./store.jks
          else
            echo "⚠ Keystore conversion failed, using original JKS format"
            echo "storeFile=store.jks" > ./store.properties
          fi
          echo "storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}" >> ./store.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> ./store.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> ./store.properties

      - name: Download Rules Files
        run: |
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      - name: Build Xray-core from Source
        run: |
          # Read NDK version from version.properties
          NDK_VERSION=$(grep '^NDK_VERSION=' version.properties | cut -d '=' -f 2 | tr -d ' ')
          NDK_MAJOR=$(echo "$NDK_VERSION" | cut -d '.' -f 1)

          # Determine NDK download URL (r28c format for version 28.x)
          if [ "$NDK_MAJOR" = "28" ]; then
            NDK_ZIP="android-ndk-r28c-linux.zip"
          else
            # Fallback to r28c if version format doesn't match
            NDK_ZIP="android-ndk-r28c-linux.zip"
          fi

          # Set up NDK
          wget -qO android-ndk.zip https://dl.google.com/android/repository/$NDK_ZIP
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)

          # Clone Xray-core source and checkout tag
          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          # Set common environment variables
          export GOOS=android
          export CGO_ENABLED=1

          # Build for arm64-v8a
          echo "Building for arm64-v8a..."
          export GOARCH=arm64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/arm64-v8a
          mv xray ../app/src/main/jniLibs/arm64-v8a/libxray.so

          # Build for x86_64
          echo "Building for x86_64..."
          export GOARCH=amd64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86_64
          mv xray ../app/src/main/jniLibs/x86_64/libxray.so

      - name: Set up Python for Model Training
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Train Policy Model
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install onnx onnxoptimizer tqdm numpy || true
          mkdir -p app/src/main/assets/models
          # Try to train model, but don't fail build if it fails
          python tools/train_hyperxray_policy_loss02_gpu.py || echo "Model training failed, continuing with build..."
        continue-on-error: true

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Find and Copy APKs
        run: |
          mkdir -p apks
          find app/build/outputs/apk/release -name "*.apk" -exec cp {} apks/ \;
          ls -lh apks/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hyperxray-apks-${{ steps.version.outputs.tag_name }}
          path: apks/
          if-no-files-found: error
          retention-days: 7

      - name: Get Release Notes
        id: release_notes
        env:
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          XRAY_VERSION: ${{ env.XRAY_VERSION }}
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          {
            echo "## Release ${TAG_NAME}"
            echo ""
            echo "### Changes"
            echo "- **Version**: ${VERSION_NAME}"
            echo "- **Xray-core**: ${XRAY_VERSION}"
            echo "- **Build Date**: ${BUILD_DATE}"
            echo ""
            echo "### APKs"
            echo "- Universal APK (all architectures)"
            echo "- ARM64-v8a APK"
            echo "- x86_64 APK"
          } > /tmp/release_notes.txt

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Release ${{ steps.version.outputs.tag_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
          files: apks/*.apk
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
