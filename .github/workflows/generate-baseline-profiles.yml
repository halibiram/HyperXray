name: Generate Baseline Profiles

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'app/src/main/**'
      - 'baselineprofile/**'
      - '.github/workflows/generate-baseline-profiles.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'app/src/main/**'
      - 'baselineprofile/**'

jobs:
  generate-profiles:
    name: Generate Baseline Profiles
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true
      
      - name: Explicit Submodule Update
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
      
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '22'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Download Geo Files
        run: ./gradlew :app:downloadGeoFiles
      
      - name: Build App (Debug)
        run: ./gradlew :app:assembleDebug
      
      - name: Install App on Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          profile: Nexus 6
          script: |
            # Wait for emulator to be ready
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\''\r'\'') ]]; do sleep 1; done'
            
            # Install debug APK
            adb install -r app/build/outputs/apk/debug/hyperxray-universal.apk || \
            adb install -r app/build/outputs/apk/debug/app-debug.apk
            
            # Grant necessary permissions
            adb shell pm grant com.hyperxray.an android.permission.INTERNET
            adb shell pm grant com.hyperxray.an android.permission.ACCESS_NETWORK_STATE
            
            # Generate baseline profiles
            ./gradlew :baselineprofile:generateBaselineProfile
            
            # Verify profile was generated
            if [ -f "baselineprofile/src/main/baseline-prof.txt" ]; then
              echo "✓ Baseline profile generated successfully"
              cat baselineprofile/src/main/baseline-prof.txt | head -20
            else
              echo "⚠️ Warning: Baseline profile file not found"
              ls -la baselineprofile/src/main/
            fi
      
      - name: Upload Baseline Profile
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: baseline-profile
          path: |
            baselineprofile/src/main/baseline-prof.txt
            app/src/main/baseline-prof.txt
          retention-days: 7
      
      - name: Commit Profile to Repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f "baselineprofile/src/main/baseline-prof.txt" ]; then
            git add baselineprofile/src/main/baseline-prof.txt
            git commit -m "chore: update baseline profile [skip ci]" || exit 0
            git push || exit 0
          fi

